// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Enums

enum UserRole {
  CUSTOMER
  ORGANIZER
}

enum EventCategory {
  TECHNOLOGY
  MUSIC
  BUSINESS
  HEALTH
  FOOD
  ART
  SPORTS
  EDUCATION
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  COMPLETED
}

enum TransactionStatus {
  WAITING_PAYMENT
  WAITING_CONFIRMATION
  DONE
  REJECTED
  EXPIRED
  CANCELED
}

enum PointSource {
  REFERRAL
  PURCHASE
}

enum DiscountType {
  PERCENTAGE
  FIXED
}


// REFERENCE TABLES (Categories & Locations)


model Category {
  id    String        @id @default(cuid())
  value EventCategory @unique 
  label String        
  icon  String        
  
  events Event[]
  
  @@map("categories")
}

model Location {
  id     String  @id @default(cuid())
  name   String  @unique
  
  events Event[]
  
  @@map("locations")
}

// USER MODEL

model User {
  id           String   @id @default(uuid())
  name         String
  email        String   @unique
  password     String
  role         UserRole @default(CUSTOMER)
  avatarUrl    String?  @map("avatar_url")
  phone        String?
  bio          String?
  referralCode String   @unique @map("referral_code")
  referredBy   String?  @map("referred_by")
  points       Int      @default(0)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  
  // Relations
  transactions Transaction[]
  reviews      Review[]
  userPoints   UserPoint[]
  referrer     User?    @relation("Referrals", fields: [referredBy], references: [referralCode])
  referrals    User[]   @relation("Referrals")
  coupons      Coupon[]
  
  // Organizer reference (if user is an organizer, they'll have events)
  events       Event[]

  @@index([referredBy])
  @@index([email])
  @@index([referralCode])
  @@index([role])
  @@map("users")
}

// EVENT MODEL

model Event {
  id               String        @id @default(cuid())
  title            String
  description      String        @db.Text
  shortDescription String?       @map("short_description")
  coverImage       String        @map("cover_image")
  images           String[]
  categoryId       String        @map("category_id")
  locationId       String        @map("location_id")
  venue            String
  date             DateTime
  endDate          DateTime?     @map("end_date")
  organizerId      String        @map("organizer_id")
  isFree           Boolean       @default(false) @map("is_free")
  status           EventStatus   @default(PUBLISHED)
  averageRating    Float         @default(0) @map("average_rating")
  totalReviews     Int           @default(0) @map("total_reviews")
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")
  
  // Relations
  organizer    User          @relation(fields: [organizerId], references: [id], onDelete: Cascade)
  ticketTiers  TicketTier[]
  transactions Transaction[]
  reviews      Review[]
  category         Category      @relation(fields: [categoryId], references: [id])
  location         Location      @relation(fields: [locationId], references: [id])
  coupons      Coupon[]
 

  @@index([categoryId]) 
  @@index([locationId]) 
  @@index([date])
  @@index([status])
  @@index([organizerId])
  @@map("events")
}

// TICKET TIER MODEL

model TicketTier {
  id          String   @id @default(cuid())
  eventId     String   @map("event_id")
  name        String
  description String
  price       Int
  quantity    Int
  sold        Int      @default(0)
  benefits    String[]
  
  // Relations
  event        Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@index([eventId])
  @@map("ticket_tiers")
}

// TRANSACTION MODEL

model Transaction {
  id             String            @id @default(cuid())
  userId         String            @map("user_id")
  eventId        String            @map("event_id")
  ticketTierId   String            @map("ticket_tier_id")
  quantity       Int
  totalAmount    Int             @map("total_amount")
  discountAmount Int             @default(0) @map("discount_amount")
  pointsUsed     Int               @default(0) @map("points_used")
  status         TransactionStatus @default(WAITING_PAYMENT)
  createdAt      DateTime          @default(now()) @map("created_at")
  expiresAt      DateTime?         @map("expires_at")
  couponId       String?           @map("coupon_id")
  
  // Relations
  user       User       @relation(fields: [userId], references: [id])
  event      Event      @relation(fields: [eventId], references: [id])
  ticketTier TicketTier @relation(fields: [ticketTierId], references: [id])
  review     Review?
  coupon         Coupon?           @relation(fields: [couponId], references: [id])

  @@index([couponId])

  @@index([userId])
  @@index([eventId])
  @@index([ticketTierId])
  @@index([status])
  @@index([createdAt])
  @@map("transactions")
}

// COUPON MODEL

model Coupon {
  id              String       @id @default(cuid())
  code            String       @unique 
  discountType    DiscountType @map("discount_type")
  discountValue   Int          @map("discount_value")
  minPurchase     Int          @default(0) @map("min_purchase")
  maxDiscount     Int?         @map("max_discount")
  usageLimit   Int      @map("usage_limit")
  usedCount    Int      @default(0) @map("used_count")
  validFrom    DateTime @map("valid_from")
  validUntil   DateTime @map("valid_until")
  isActive     Boolean  @default(true) @map("is_active")
  eventId      String?  @map("event_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  userId       String?  @map("user_id")  
  

  // Relation
  event           Event?       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user         User?    @relation(fields: [userId], references: [id])
  transactions    Transaction[]


  @@index([userId])
  @@index([code])
  @@index([eventId])
  @@map("coupons")
}

// REVIEW MODEL

model Review {
  id            String   @id @default(cuid())
  userId        String   @map("user_id")
  eventId       String   @map("event_id")
  transactionId String   @unique @map("transaction_id")
  rating        Int
  comment       String?  @db.Text
  createdAt     DateTime @default(now()) @map("created_at")
  
  // Relations
  user        User        @relation(fields: [userId], references: [id])
  event       Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  transaction Transaction @relation(fields: [transactionId], references: [id])

  @@index([eventId])
  @@index([userId])
  @@map("reviews")
}

// USER POINTS MODEL

model UserPoint {
  id        String      @id @default(cuid())
  userId    String      @map("user_id")
  amount    Int
  source    PointSource
  expiresAt DateTime    @map("expires_at")
  createdAt DateTime    @default(now()) @map("created_at")
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("user_points")
}